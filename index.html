<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lex Bot</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

  <style>
    :root{
      --brand-main:#AC1818;  /* gÅ‚Ã³wny */
      --brand-accent:#F6EA2A;/* akcent */
      --brand-alt:#7C1D1C;   /* hover */
      --brand-text:#0b1020;
      --brand-muted:#6b7280;
      --brand-border:#d1d5db;
      --brand-bg:#ffffff;

      /* n8n widget */
      --chat--color-primary: var(--brand-main);
      --chat--color-secondary: var(--brand-accent);
      --chat--color-white:#fff;
      --chat--color-dark:#111827;

      --chat--message--bot--background:#fff;
      --chat--message--bot--color:var(--brand-text);
      --chat--message--user--background:var(--brand-main);
      --chat--message--user--color:#fff;
      --chat--message--border-radius:18px;
      --chat--message-line-height:1.6;

      --chat--header--background: var(--brand-main);
      --chat--header--color:#fff;

      --chat--window--width:100%;
      --chat--window--height:100%;
      --chat--border-radius:18px;
      --chat--textarea--height:52px;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#fff; color:var(--brand-text); }
    body, input, button, label{ font-family:'Poppins','Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #n8n-chat, #n8n-chat *{ font-family:'Poppins','Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif !important; }

    /* Launcher (prawy-dÃ³Å‚) */
    #chat-launcher{
      position:fixed; right:20px; bottom:20px; z-index:10000;
      width:64px; height:64px; border-radius:50%;
      background:var(--brand-main); color:#fff; border:0;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 24px rgba(0,0,0,.2);
      cursor:pointer; transition:background .15s ease;
    }
    #chat-launcher:hover{ background:var(--brand-alt); }
    #chat-launcher svg{ width:42px; height:42px; display:block; }

/* âžœ Zielona kropka dostÄ™pnoÅ›ci (badge) */
#chat-launcher::after{
  content:"";
  position:absolute;
  left:-0px;          /* zmieÅ„ na right:-2px; jeÅ›li ma byÄ‡ po prawej */
  bottom:-0px;
  width:16px; height:16px;
  border-radius:50%;
  background:#2ECC71;           /* zielony status (online) */
  border:2px solid #fff;        /* biaÅ‚y ring */
  box-shadow:0 2px 8px rgba(0,0,0,.18);
  pointer-events:none;          /* nie blokuje klikniÄ™cia w przycisk */
}

    /* Okno czatu */
    #chat-modal{
      position:fixed; right:20px; bottom:100px; z-index:9999;
      width:420px; max-width:calc(100% - 40px); height:640px;
      background:var(--brand-bg); border-radius:18px;
      box-shadow:0 20px 48px rgba(0,0,0,.24);
      display:none; flex-direction:column; overflow:hidden;
      border:1px solid #ececec;
    }

    /* Header Lex Bot */
    #chat-header{
      background:var(--brand-main); color:#fff;
      padding:8px 12px; min-height:60px;
      display:flex; align-items:center; justify-content:space-between;
    }
    #brand-wrap{ display:flex; align-items:center; gap:10px; min-width:0; }
    #chat-header .avatar{ width:36px; height:36px; border-radius:50%; background:#fff1; display:grid; place-items:center; border:2px solid #ffffff66; }
    #chat-header .avatar svg{ width:22px; height:22px; display:block; }
    #chat-header .meta{ display:flex; flex-direction:column; line-height:1.1; }
    #chat-header .bot-name{ font-family:"Segoe UI","Segoe UI Variable","Segoe UI Web",system-ui,-apple-system,Roboto,Arial,sans-serif; font-weight:700; font-size:16px; letter-spacing:.2px; }
    #chat-header .bot-sub{ font-family:"Segoe UI","Segoe UI Variable","Segoe UI Web",system-ui,-apple-system,Roboto,Arial,sans-serif; font-weight:400; font-size:12px; opacity:.95; display:flex; align-items:center; gap:6px; }
    #chat-header .online-dot{ width:10px; height:10px; border-radius:50%; background:#2ecc71; box-shadow:0 0 0 2px #ffffff55 inset; }

    /* StrzaÅ‚ka minimalizacji: jednolite, peÅ‚ne kÃ³Å‚ko na hover/focus â€” bez obwÃ³dki */
    #chat-minimize{
      background: transparent; border: 0; color:#fff; cursor: pointer;
      width: 36px; height: 36px; padding: 0;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      transition: background-color .15s ease, transform .05s ease;
      box-shadow: none;                     /* brak ringu */
    }

    #chat-minimize:hover{
      background: var(--brand-alt) !important;  /* peÅ‚ne kÃ³Å‚ko, ciemnoczerwone */
      box-shadow: none !important;              /* zero obwÃ³dki */
    }

    #chat-minimize:focus-visible{
      outline: none;
      background: var(--brand-alt) !important;  /* teÅ¼ peÅ‚ne kÃ³Å‚ko */
      box-shadow: none !important;              /* zero obwÃ³dki */
    }

    #chat-minimize:active{
      transform: translateY(1px);
    }

    #chat-minimize svg{
      width: 22px; height: 22px; display: block;
      pointer-events: none; /* klik trafia w button */
    }




    #chat-body{ flex:1; min-height:0; display:flex; }

    /* Formularz wstÄ™pny */
    #prechat-form{ width:100%; height:100%; padding:16px; overflow:auto; }
    form#prechat-form p.topnote{ margin:0 0 8px; font-size:13px; color:var(--brand-muted); }
    form#prechat-form .field{ margin-bottom:12px; }
    form#prechat-form .field label{ display:block; font-size:13px; margin-bottom:6px; color:#111; }
    form#prechat-form .field input[type="text"],
    form#prechat-form .field input[type="email"],
    form#prechat-form .field input[type="tel"]{
      width:100%; max-width:100%; height:44px; padding:10px 12px;
      border:1.5px solid var(--brand-border); border-radius:14px;
      font-size:14px; background:#fff; color:var(--brand-text);
      outline:none; transition:border-color .15s, box-shadow .15s;
    }
    form#prechat-form .field input::placeholder{ color:#9ca3af; }
    form#prechat-form .field input:focus{ border-color:var(--brand-main); box-shadow:0 0 0 3px color-mix(in srgb, var(--brand-main) 22%, transparent); }

    /* Checkbox â€“ kwadrat 20x20, nieprzycinany, animowany */
    form#prechat-form .consent { display:flex; gap:12px; align-items:flex-start; font-size:13px; color:#333; }
    form#prechat-form .consent a { color: var(--brand-accent); text-decoration: underline; }

    form#prechat-form .consent input[type="checkbox"]{
      appearance: none; -webkit-appearance: none;
      width: 18px; height: 18px;
      flex: 0 0 20px; min-width:20px; min-height:20px;
      border: 2px solid var(--brand-border);
      border-radius: 2px;
      background: #fff;
      display: inline-flex; align-items: center; justify-content: center;
      overflow: hidden;
      cursor: pointer; vertical-align: text-top;
      transition: border-color .2s, background-color .2s, box-shadow .2s, transform .08s;
      margin-top: 2px; padding: 0; line-height: 0;
    }
    form#prechat-form .consent input[type="checkbox"]::before{
      content: ""; width:12px; height:7px;
      border-left:3px solid #fff; border-bottom:3px solid #fff;
      transform: rotate(-45deg) scale(0); transform-origin:center;
      transition: transform .16s ease-in-out;
    }
    form#prechat-form .consent input[type="checkbox"]:hover { border-color: var(--brand-main); }
    form#prechat-form .consent input[type="checkbox"]:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(172,24,24,.18); border-color:var(--brand-main); }
    form#prechat-form .consent input[type="checkbox"]:checked{ background:var(--brand-main); border-color:var(--brand-main); }
    form#prechat-form .consent input[type="checkbox"]:checked::before{ transform: rotate(-45deg) scale(1); }
    form#prechat-form .consent input[type="checkbox"].invalid{ border-color:var(--brand-main); box-shadow:0 0 0 3px rgba(172,24,24,.18); }
    form#prechat-form .consent input[type="checkbox"]:disabled{ cursor:not-allowed; opacity:.6; }

    form#prechat-form .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    form#prechat-form .btn{ padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:700; border:1px solid var(--brand-main); background:var(--brand-main); color:#fff; transition:background .15s, border-color .15s; }
    form#prechat-form .btn:hover{ background:var(--brand-alt); border-color:var(--brand-alt); }
    form#prechat-form .note{ font-size:12px; color:var(--brand-muted); margin-top:10px; }
    form#prechat-form .error{ color:var(--brand-main); font-size:12px; margin-top:4px; display:none; }

    /* n8n mount */
    #chat-container{ width:100%; height:100%; display:none; }
    #n8n-chat{ width:100%; height:100%; }

    /* Kill-switch na ewentualny welcome z n8n */
    #n8n-chat [class*="welcome"],
    #n8n-chat [data-test-id*="welcome"],
    #n8n-chat [data-testid*="welcome"]{
      display:none !important; height:0 !important; padding:0 !important; margin:0 !important; visibility:hidden !important; opacity:0 !important;
    }

/* ===== WYÅšLIJ: tylko ikonka (tÅ‚o zawsze przezroczyste) ===== */
#n8n-chat .lex-send,
#n8n-chat .lex-send:hover,
#n8n-chat .lex-send.lex-active,
#n8n-chat .lex-send.lex-active:hover{
  background:#fff !important;            /* biaÅ‚e tÅ‚o */
  border:1px solid #fff !important;      /* brak szarej obwÃ³dki */
  box-shadow:none !important;
}


/* szara ikonka gdy brak treÅ›ci */
#n8n-chat .lex-send:not(.lex-active) svg,
#n8n-chat .lex-send:not(.lex-active) svg *{
  fill:#9ca3af !important;
  stroke:#9ca3af !important;
  transition: fill .15s ease, stroke .15s ease;
}

/* czerwona ikonka gdy jest treÅ›Ä‡ */
#n8n-chat .lex-send.lex-active svg,
#n8n-chat .lex-send.lex-active svg *{
  fill: var(--brand-main) !important;
  stroke: var(--brand-main) !important;
}

/* ciemnoczerwona na hover */
#n8n-chat .lex-send.lex-active:hover svg,
#n8n-chat .lex-send.lex-active:hover svg *{
  fill: var(--brand-alt) !important;
  stroke: var(--brand-alt) !important;
}


/* ===== SPINACZ: tylko ikonka (tÅ‚o zawsze przezroczyste) ===== */
#n8n-chat .lex-attach,
#n8n-chat .lex-attach:hover{
  background:#fff !important;           /* biaÅ‚e tÅ‚o */
  border:1px solid #fff !important;     /* brak szarej obwÃ³dki */
  box-shadow:none !important;
}


/* czerwona ikonka spinacza */
#n8n-chat .lex-attach svg,
#n8n-chat .lex-attach svg *{
  fill: var(--brand-main) !important;
  stroke: var(--brand-main) !important;
  transition: fill .15s ease, stroke .15s ease;
}

/* ciemnoczerwona na hover */
#n88n-chat .lex-attach:hover svg,
#n8n-chat .lex-attach:hover svg *{
  fill: var(--brand-alt) !important;
  stroke: var(--brand-alt) !important;
}

/* ===== ZaÅ‚Ä…czniki (CHIP): czerwone piguÅ‚ki z biaÅ‚Ä… ikonÄ…/nazwÄ…/X ===== */
#n8n-chat .lex-file{
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
  padding: 6px 12px !important;
  border-radius: 9999px !important;         /* peÅ‚ne zaokrÄ…glenie */
  background: var(--brand-main) !important; /* czerwone tÅ‚o */
  border: none !important;                  /* zero obwÃ³dek */
  box-shadow: none !important;
  white-space: nowrap !important;
}

/* biaÅ‚y tekst/nazwa pliku i linki w chipie */
#n8n-chat .lex-file,
#n8n-chat .lex-file a,
#n8n-chat .lex-file span,
#n8n-chat .lex-file div{
  color:#fff !important;
  font-size:14px !important;
  font-weight:600 !important;
  line-height:1.1 !important;
}

#n8n-chat .lex-file:hover{
  background: var(--brand-alt) !important;  /* ciemnoczerwony na hover */
}

/* biaÅ‚a ikonka pliku w chipie */
#n8n-chat .lex-file svg,
#n8n-chat .lex-file svg *{
  fill:#fff !important;
  stroke:#fff !important;
}

/* Przycisk X (usuÅ„) â€“ biaÅ‚a ikona, okrÄ…gÅ‚y hover w ciemnej czerwieni */
#n8n-chat .lex-file .lex-file-remove{
  width:22px !important;
  height:22px !important;
  display:inline-grid !important;
  place-items:center !important;
  border-radius:50% !important;             /* okrÄ…gÅ‚y hover */
  background:transparent !important;
  border:none !important;
  margin-left:4px !important;
  cursor:pointer !important;
}

#n8n-chat .lex-file .lex-file-remove:hover{
  background: var(--brand-alt) !important;   /* ciemnoczerwony bubble pod X */
}

#n8n-chat .lex-file .lex-file-remove svg,
#n8n-chat .lex-file .lex-file-remove svg *{
  fill:#fff !important;
  stroke:#fff !important;
}

    @media (max-height:750px){ #chat-modal{ height:80vh; } }
  </style>
</head>
<body>

  <button id="chat-launcher" aria-label="OtwÃ³rz czat">
  <svg viewBox="0 0 24 24" fill="none"
       stroke="currentColor" stroke-width="1.8" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round"
      d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
  </svg>
</button>


  <section id="chat-modal" role="dialog" aria-modal="true" aria-labelledby="chat-title">
    <header id="chat-header">
      <div id="brand-wrap">
        <div class="avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <rect x="3" y="7" width="18" height="12" rx="6" ry="6" stroke="#fff" stroke-width="2"/>
            <circle cx="9" cy="13" r="1.5" fill="#fff"/>
            <circle cx="15" cy="13" r="1.5" fill="#fff"/>
            <rect x="10.5" y="4" width="3" height="3" rx="1.5" fill="#fff"/>
          </svg>
        </div>
        <div class="meta">
          <div class="bot-name">Lex Bot</div>
          <div class="bot-sub"><span class="online-dot"></span> Asystent AI</div>
        </div>
      </div>
      <button id="chat-minimize" aria-label="Zminimalizuj czat">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 9l6 6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </header>

    <div id="chat-body">
      <form id="prechat-form" novalidate>

        <div class="field">
          <label for="fullName">ImiÄ™ i nazwisko</label>
          <input id="fullName" name="fullName" type="text" placeholder="Jan Kowalski" />
          <div id="err-fullName" class="error"></div>
        </div>

        <div class="field">
          <label for="email">Adres e-mail</label>
          <input id="email" name="email" type="email" placeholder="jan.kowalski@example.com" />
          <div id="err-email" class="error"></div>
        </div>

        <div class="field">
          <label for="phone">Nr telefonu</label>
          <input id="phone" name="phone" type="tel" placeholder="+48 600 000 000" />
          <div id="err-phone" class="error"></div>
        </div>

        <div class="field">
          <label for="city">MiejscowoÅ›Ä‡</label>
          <input id="city" name="city" type="text" placeholder="KrakÃ³w" />
        </div>

        <div class="consent">
          <input id="consent" name="consent" type="checkbox" />
          <label for="consent">Zgoda na przetwarzanie danych osobowych w celu realizacji rozmowy i kontaktu zwrotnego. <a href="/polityka-prywatnosci" target="_blank" rel="noopener">Polityka prywatnoÅ›ci</a>.</label>
        </div>
        <div id="err-consent" class="error" style="margin-top:6px;"></div>

        <div class="actions">
          <button type="submit" class="btn">Rozpocznij czat</button>
        </div>

        </form>

      <div id="chat-container">
        <div id="n8n-chat"></div>
      </div>
    </div>
  </section>

  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    /* === KONFIG === */
    const WEBHOOK = 'https://instancja1.runloop.pl/webhook/54872652-f844-4927-9804-91a177f09f38/chat';
    const TTL_MS = 60 * 60 * 1000; // 1 godz.
    const STORAGE = { DATA:'prechatDataV1', LAST:'prechatLastActiveAt', ALIVE:'sessionAlive' };

    /* === UI refs === */
    const launcher = document.getElementById('chat-launcher');
    const modal    = document.getElementById('chat-modal');
    const minimize = document.getElementById('chat-minimize');
    const preForm  = document.getElementById('prechat-form');
    const chatWrap = document.getElementById('chat-container');

    /* === Stan: uruchomiono chat widget? === */
    let chatBooted = false;

    /* === Helpers: activity & storage === */
    const now = () => Date.now();
    const markActivity = () => localStorage.setItem(STORAGE.LAST, String(now()));
    const loadSaved = () => { try { return JSON.parse(localStorage.getItem(STORAGE.DATA) || 'null'); } catch { return null; } };
    const saveData  = (d) => { localStorage.setItem(STORAGE.DATA, JSON.stringify(d)); markActivity(); };
    function clearSession(){ localStorage.removeItem(STORAGE.DATA); localStorage.removeItem(STORAGE.LAST); }
    const inactivityExpired = () => { const last = Number(localStorage.getItem(STORAGE.LAST) || '0'); return !last || (now() - last) > TTL_MS; };
    function ensureBrowserSession(){ if (!sessionStorage.getItem(STORAGE.ALIVE)) { sessionStorage.setItem(STORAGE.ALIVE,'1'); clearSession(); } }
    function maybeResetByTTL(){ if (inactivityExpired()) clearSession(); }
    setInterval(maybeResetByTTL, 60*1000);

    /* Walidacja */
    function showError(id, on, text){ const el=document.getElementById(id); if(!el) return; if(text) el.textContent=text; el.style.display=on?'block':'none'; }
   function validateData(d){
Â  Â  Â  const errors = []; // Lista bÅ‚Ä™dÃ³w

Â  Â  Â  // 1. Zresetuj wszystkie bÅ‚Ä™dy przed nowÄ… walidacjÄ…
Â  Â  Â  showError('err-fullName', false);
Â  Â  Â  showError('err-email', false);
Â  Â  Â  showError('err-phone', false);
Â  Â  Â  showError('err-consent', false);
Â  Â  Â  const box = document.getElementById('consent');
Â  Â  Â  if (box) box.classList.remove('invalid');

Â  Â  Â  // 2. Walidacja: ImiÄ™ i nazwisko (min 2 znaki)
Â  Â  Â  if (!d.fullName || d.fullName.trim().length < 2) {
Â  Â  Â  Â  errors.push('fullName');
Â  Â  Â  Â  showError('err-fullName', true, 'ProszÄ™ podaÄ‡ imiÄ™ i nazwisko.');
Â  Â  Â  }

Â  Â  Â  // 3. Walidacja: E-mail (prosty regex)
Â  Â  Â  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
Â  Â  Â  if (!d.email || !emailRegex.test(d.email)) {
Â  Â  Â  Â  errors.push('email');
Â  Â  Â  Â  showError('err-email', true, 'ProszÄ™ podaÄ‡ poprawny adres e-mail.');
Â  Â  Â  }

Â  Â  Â  // 4. Walidacja: Telefon (min. 9 cyfr po usuniÄ™ciu spacji/znakÃ³w)
Â  Â  Â  const phoneDigits = (d.phone || '').replace(/[\s+()-]/g, '');
Â  Â  Â  if (phoneDigits.length < 9) {
Â  Â  Â  Â  errors.push('phone');
Â  Â  Â  Â  showError('err-phone', true, 'ProszÄ™ podaÄ‡ poprawny numer telefonu (min. 9 cyfr).');
Â  Â  Â  }

Â  Â  Â  // 5. Walidacja: Zgoda
Â  Â  Â  if (!d.consent) {
Â  Â  Â  Â  errors.push('consent');
Â  Â  Â  Â  showError('err-consent', true, 'Zgoda na przetwarzanie danych jest wymagana.');
Â  Â  Â  Â  if (box) box.classList.add('invalid'); // Dodaj czerwonÄ… ramkÄ™ do checkboxa
Â  Â  Â  }

Â  Â  Â  // ZwrÃ³Ä‡ tablicÄ™ bÅ‚Ä™dÃ³w. JeÅ›li jest pusta (dÅ‚ugoÅ›Ä‡ 0), formularz jest waÅ¼ny.
Â  Â  Â  return errors;
Â  Â  }
	  
    function readForm(form){
      const get=(id)=>form.querySelector('#'+id)?.value?.trim()||'';
      return { fullName:get('fullName'), email:get('email'), phone:get('phone'), city:get('city')||null, consent: form.querySelector('#consent')?.checked===true };
    }
    const isValid=(d)=>validateData(d).length===0;

    /* (awaryjnie) ukryj welcome z n8n */
    function suppressWelcome(){
      const root=document.getElementById('n8n-chat');
      if(!root) return;
      const wipe=()=>{
        root.querySelectorAll('[data-testid*="welcome"],[data-test-id*="welcome"],[class*="welcome"]').forEach(el=>el.remove());
        root.querySelectorAll('h1,h2,p,div,section').forEach(el=>{
          const t=(el.textContent||'').trim().toLowerCase();
          if(t.startsWith('hi there') || t.includes('start a chat')) (el.closest('section,div')||el).remove();
        });
      };
      wipe();
      new MutationObserver(wipe).observe(root,{childList:true,subtree:true});
    }

    /* Kolorowanie przycisku wysÅ‚ania: zakÅ‚adamy klasÄ™ na przycisku i przeÅ‚Ä…czamy stan */


/* Kolorowanie kontrolek: spinacz (staÅ‚e czerwone) + wysyÅ‚ka (szary â†’ czerwony po treÅ›ci)
   + poprawka po wysÅ‚aniu (przycisk wraca na szaro) i rehook po re-renderze n8n */
function wireControlsColor() {
  const root = document.getElementById('n8n-chat');
  if (!root) return;

  const hook = () => {
    const input = root.querySelector('textarea, input[type="text"]');
    if (!input) return false;

    const container = input.closest('form,div,section');
    if (!container) return false;

    const buttons = Array.from(container.querySelectorAll('button')).filter(b => b.querySelector('svg'));
    if (buttons.length === 0) return false;

    // ZaÅ‚oÅ¼enie: ostatni z ikonÄ… = WYÅšLIJ, inny = SPINACZ
    const sendBtn   = buttons[buttons.length - 1];
    const attachBtn = buttons.find(b => b !== sendBtn);

    sendBtn.classList.add('lex-send');
    if (attachBtn) attachBtn.classList.add('lex-attach');

    const setState = () => {
      const hasText = (input.value || '').trim().length > 0;
      sendBtn.classList.toggle('lex-active', hasText);
    };

    // Aktualizacje w trakcie pisania
    input.addEventListener('input', setState);
    input.addEventListener('change', setState);
    input.addEventListener('blur', setState);

    // Po wysÅ‚aniu wiadomoÅ›ci n8n czyÅ›ci pole asynchronicznie â†’ przelicz stan po chwili
    const afterSend = () => {
      setTimeout(setState, 0);
      setTimeout(setState, 60);
      setTimeout(setState, 150);
    };
    sendBtn.addEventListener('click', afterSend, true);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) afterSend();
    });

    // JeÅ›li n8n podmieni input/przyciski w DOM â†’ rehook
    const ro = new MutationObserver(() => {
      const iNow = root.querySelector('textarea, input[type="text"]');
      const sNow = iNow?.closest('form,div,section')?.querySelector('button svg')?.closest('button');
      if (iNow !== input || sNow !== sendBtn) {
        ro.disconnect();
        hook(); // podÅ‚Ä…cz ponownie do nowych elementÃ³w
      } else {
        // na wszelki wypadek utrzymuj poprawny stan
        setState();
      }
    });
    ro.observe(root, { childList: true, subtree: true });

    setState(); // stan poczÄ…tkowy
    return true;
  };

  // Pierwsze podpiÄ™cie (jeÅ›li widget jeszcze siÄ™ renderuje â€” poczekaj)
  if (!hook()) {
    const mo = new MutationObserver(() => { if (hook()) mo.disconnect(); });
    mo.observe(root, { childList: true, subtree: true });
  }
}




    /* Start n8n chat â€” TYLKO RAZ */
    function bootChat(meta){
      if (chatBooted) return; // nie inicjalizuj ponownie
      chatBooted = true;
      markActivity();

      createChat({
        webhookUrl: WEBHOOK,
        target: '#n8n-chat',
        mode: 'fullscreen',
        loadPreviousSession: true,   // pozwala wczytaÄ‡ historiÄ™, jeÅ›li pamiÄ™Ä‡ w n8n jest spiÄ™ta
        enableStreaming: true,
        showWelcomeScreen: false,
		allowFileUploads: true,
        allowedFilesMimeTypes: [
        // PDF
        'application/pdf',

        // Obrazy
        'image/*',

        // Office / OpenOffice
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
        'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
        'application/vnd.oasis.opendocument.text', // .odt

        // Inne tekstowe / publikacyjne
        'application/epub+zip',               // .epub
        'application/docbook+xml',            // DocBook XML
        'application/rtf',                    // .rtf
        'application/x-biblatex',
        'application/x-bibtex',
        'application/x-endnote+xml',
        'application/x-fictionbook+xml',
        'application/x-ipynb+json',           // .ipynb
        'application/x-jats+xml',             // JATS XML
        'application/x-latex',                // .tex
        'application/x-opml+xml',             // .opml
        'text/troff',                         // man pages
        'text/x-dokuwiki'                     // DokuWiki
    	],
        initialMessages: [
          'Witaj! ðŸ˜Š',
          'Jestem wirtualnym asystentem kancelarii. Jak mogÄ™ Ci pomÃ³c?'
        ],
        metadata: {
          ...meta,
          page: window.location.href,
          referrer: document.referrer || null,
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
          lang: navigator.language || 'pl-PL',
          formVersion: '1.7.0',
          ts: new Date().toISOString(),
        },
        i18n: { en: { inputPlaceholder: 'Napisz wiadomoÅ›Ä‡â€¦', getStarted: 'Nowa rozmowa' } }
      });

     wireControlsColor();



      const n8nRoot=document.getElementById('n8n-chat');
      const activity=()=>markActivity();
      n8nRoot.addEventListener('click',activity,true);
      n8nRoot.addEventListener('keydown',activity,true);
      suppressWelcome();
    }

    /* Init sesji (reset na restart/po 1h) */
    ensureBrowserSession();
    maybeResetByTTL();

    /* OtwÃ³rz: pokaÅ¼ modal; uruchom chat TYLKO jeÅ›li jeszcze nie uruchomiony */
    launcher.addEventListener('click', () => {
      const isOpen = getComputedStyle(modal).display !== 'none';

      // jeÅ›li otwarte â€“ zminimalizuj
      if (isOpen) {
        modal.style.display = 'none';
        return;
      }

      // jeÅ›li zamkniÄ™te â€“ otwÃ³rz
      modal.style.display = 'flex';
      markActivity();

      if (chatBooted) {
        preForm.style.display = 'none';
        chatWrap.style.display = 'block';
        return;
      }

      const saved = loadSaved();
      if (saved && isValid(saved) && !inactivityExpired()) {
        preForm.style.display = 'none';
        chatWrap.style.display = 'block';
        bootChat(saved);
      } else {
        preForm.style.display = 'block';
        chatWrap.style.display = 'none';
      }
    });


    /* Minimalizacja (nie resetuje niczego) */
    minimize.addEventListener('click', () => {
      modal.style.display = 'none';
      // stan czatu zostaje w DOM; przy kolejnym otwarciu tylko pokaÅ¼emy modal
    });

    /* ESC teÅ¼ minimalizuje */
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display !== 'none') {
        modal.style.display = 'none';
      }
    });

    /* Submit formularza => start czatu (tylko raz) */
    preForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const data = readForm(preForm);
      if (validateData(data).length) return;
      saveData(data);
      preForm.style.display = 'none';
      chatWrap.style.display = 'block';
      bootChat(data);
    });

    /* aktywnoÅ›Ä‡ */
    window.addEventListener('focus', markActivity);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) markActivity(); });
  </script>
</body>
</html>
